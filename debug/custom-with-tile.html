<!DOCTYPE html>
<html lang="en">
    <head>
        <title>MapLibre GL JS debug page</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="../dist/maplibre-gl.css" />
        <style>
            body {
                margin: 0;
                padding: 0;
            }
            html,
            body,
            #map {
                height: 100%;
            }
        </style>
    </head>

    <body>
        <div id="map"></div>

        <script src="../dist/maplibre-gl-dev.js"></script>
        <script src="https://unpkg.com/three@0.106.2/build/three.min.js"></script>
        <script>
            const map = (window.map = new maplibregl.Map({
                container: 'map',
                zoom: 16,
                center: [13.418056, 52.499167],
                style: {
                    version: 8,
                    sources: {
                        osm: {
                            type: 'raster',
                            tiles: [
                                'http://tile.openstreetmap.org/{z}/{x}/{y}.png',
                            ],
                            attribution:
                                '<a href="https://maps.gsi.go.jp/development/ichiran.html">Geospatial Information Authority of Japan</a>',
                        },
                    },
                    layers: [
                        {
                            id: 'osm',
                            source: 'osm',
                            type: 'raster',
                        },
                    ],
                },
                hash: true,
            }));
            class TileSource {
                constructor() {
                    this.id = 'tile-source';
                    this.type = 'custom';
                    this.renderingMode = '3d';
                    this.source = 'osm';
                    this.minzoom = 2;
                    this.maxzoom = 17;
                }

                onAdd(map, gl) {
                    const vertexSource = `

                    attribute vec3 aPos;
                    attribute vec2 aTexCoord;
                    uniform mat4 uMatrix;
                    varying vec2 vTexCoord;

                    void main() {
                        gl_Position = uMatrix * vec4(aPos, 1.0);
                        vTexCoord = aTexCoord;
                    }
                    `;

                    const fragmentSource = `
                    precision mediump float;
                    uniform sampler2D uTexture;
                    varying vec2 vTexCoord;
                    void main() {
                        gl_FragColor = texture2D(uTexture, vTexCoord);
                    }
                    `;

                    const vertexShader = gl.createShader(gl.VERTEX_SHADER);
                    gl.shaderSource(vertexShader, vertexSource);
                    gl.compileShader(vertexShader);
                    const fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
                    gl.shaderSource(fragmentShader, fragmentSource);
                    gl.compileShader(fragmentShader);

                    this.program = gl.createProgram();
                    gl.attachShader(this.program, vertexShader);
                    gl.attachShader(this.program, fragmentShader);
                    gl.linkProgram(this.program);

                    this.aPos = gl.getAttribLocation(this.program, 'aPos');
                    this.aTexCoord = gl.getAttribLocation(
                        this.program,
                        'aTexCoord',
                    );
                    this.uMatrix = gl.getUniformLocation(
                        this.program,
                        'uMatrix',
                    );
                    this.uTexture = gl.getUniformLocation(
                        this.program,
                        'uTexture',
                    );

                    const { x, y } = maplibregl.MercatorCoordinate.fromLngLat({
                        lng: 13.418056,
                        lat: 52.499167,
                    });
                    const vertexArray = new Float32Array([
                        x - 0.00001,
                        y,
                        0,
                        x + 0.00001,
                        y,
                        0,
                        x,
                        y + 0.00001,
                        0,
                    ]);
                    const texCoordArray = new Float32Array([
                        0.0, 0.0, 1.0, 0.0, 0.0, 1.0,
                    ]);

                    // bind vertex
                    this.vertexBuffer = gl.createBuffer();
                    gl.bindBuffer(gl.ARRAY_BUFFER, this.vertexBuffer);
                    gl.bufferData(gl.ARRAY_BUFFER, vertexArray, gl.STATIC_DRAW);
                    gl.enableVertexAttribArray(this.aPos);
                    gl.vertexAttribPointer(this.aPos, 3, gl.FLOAT, false, 0, 0);

                    // bind texCoord
                    this.texCoordBuffer = gl.createBuffer();
                    gl.bindBuffer(gl.ARRAY_BUFFER, this.texCoordBuffer);
                    gl.bufferData(
                        gl.ARRAY_BUFFER,
                        texCoordArray,
                        gl.STATIC_DRAW,
                    );
                    gl.enableVertexAttribArray(this.aTexCoord);
                    gl.vertexAttribPointer(
                        this.aTexCoord,
                        2,
                        gl.FLOAT,
                        false,
                        0,
                        0,
                    );
                }

                render(gl, matrix, tiles) {
                    if (tiles.length === 0) return;
                    console.log(tiles);
                    gl.useProgram(this.program);

                    // bind texture
                    const { texture } = tiles[0];
                    gl.bindTexture(gl.TEXTURE_2D, texture.texture);
                    gl.uniform1i(this.uTexture, 0);

                    // render
                    gl.uniformMatrix4fv(this.uMatrix, false, matrix);
                    gl.drawElements(gl.TRIANGLES, 3, gl.UNSIGNED_SHORT, 0);
                }
            }

            map.on('load', function () {
                map.addLayer(new TileSource());
            });
        </script>
    </body>
</html>
